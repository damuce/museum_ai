<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Museum AI Guide</title>
    <!-- Tailwind CSS (via CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes pulse-ring {
            0% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .animate-pulse-ring { animation: pulse-ring 2s infinite; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%;
            background: #facc15; cursor: pointer; margin-top: -6px;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 8px; cursor: pointer; background: #4b5563; border-radius: 4px;
        }
    </style>
</head>
<body class="bg-black text-white h-screen w-screen overflow-hidden flex flex-col font-sans">

    <!-- Audio Element for AI Voice -->
    <audio id="ai-audio-player" class="hidden"></audio>

    <!-- 1. HEADER / TOP BAR -->
    <header class="absolute top-0 left-0 w-full z-20 p-4 flex justify-between items-center bg-gradient-to-b from-black/70 to-transparent">
        <div class="flex items-center space-x-2">
            <i class="fa-solid fa-building-columns text-yellow-400"></i>
            <h1 class="font-bold text-lg tracking-wide">Museum AI</h1>
        </div>
        <button id="btn-settings" class="bg-gray-800/80 backdrop-blur text-white px-3 py-1.5 rounded-full text-sm border border-gray-600">
            <i class="fa-solid fa-gear mr-1"></i> Settings
        </button>
    </header>

    <!-- 2. CAMERA VIEWPORT -->
    <div class="relative flex-1 bg-gray-900 w-full overflow-hidden">
        <video id="camera-feed" class="absolute inset-0 w-full h-full object-cover" autoplay playsinline muted></video>
        <canvas id="capture-canvas" class="hidden"></canvas>
        <div id="camera-placeholder" class="absolute inset-0 flex flex-col items-center justify-center bg-gray-900 z-10 hidden">
            <i class="fa-solid fa-camera-slash text-4xl text-gray-600 mb-4"></i>
            <p class="text-gray-400">Camera access required</p>
        </div>
    </div>

    <!-- 3. RESULT OVERLAY -->
    <div id="result-sheet" class="absolute bottom-0 left-0 w-full bg-gray-900/95 backdrop-blur-md rounded-t-3xl border-t border-gray-700 transition-transform duration-300 transform translate-y-[110%] z-30 max-h-[70vh] flex flex-col shadow-2xl">
        <div class="w-full flex justify-center pt-3 pb-1">
            <div class="w-12 h-1.5 bg-gray-600 rounded-full"></div>
        </div>
        
        <div class="px-6 py-4 flex justify-between items-center border-b border-gray-800">
            <span class="text-sm text-gray-400 uppercase tracking-wider font-semibold">AI Explanation</span>
            <div class="flex items-center space-x-8">
                <button id="btn-play" class="text-yellow-400 hover:text-yellow-300 active:scale-90 transition-transform">
                    <i class="fa-solid fa-play text-4xl"></i>
                </button>
                <button id="btn-pause" class="text-yellow-400 hover:text-yellow-300 active:scale-90 transition-transform">
                    <i class="fa-solid fa-pause text-4xl"></i>
                </button>
                <button id="btn-close-result" class="text-gray-400 hover:text-white active:scale-90 transition-transform ml-2">
                    <i class="fa-solid fa-times text-4xl"></i>
                </button>
            </div>
        </div>

        <div class="p-6 overflow-y-auto no-scrollbar flex-1">
            <div id="loading-state" class="hidden flex flex-col items-center justify-center py-8">
                <i class="fa-solid fa-circle-notch fa-spin text-3xl text-yellow-400 mb-3"></i>
                <p class="text-sm text-gray-300 animate-pulse">Consulting AI Curator...</p>
            </div>
            <div id="explanation-text" class="text-lg leading-relaxed text-gray-100 italic"></div>
        </div>
    </div>

    <!-- 4. BOTTOM ACTION BAR -->
    <div class="absolute bottom-0 w-full z-20 p-6 flex justify-center items-end bg-gradient-to-t from-black/80 via-black/40 to-transparent h-32">
        <button id="btn-capture" class="w-20 h-20 rounded-full border-4 border-white/80 bg-white/20 backdrop-blur-sm flex items-center justify-center transition-all active:scale-95 shadow-lg">
            <div class="w-16 h-16 bg-white rounded-full"></div>
        </button>
    </div>

    <!-- 5. SETTINGS MODAL -->
    <div id="settings-modal" class="fixed inset-0 z-50 bg-black/80 backdrop-blur-sm flex items-center justify-center hidden opacity-0 transition-opacity duration-300">
        <div class="bg-gray-800 w-11/12 max-w-md rounded-2xl p-6 border border-gray-700 shadow-2xl overflow-y-auto max-h-[90vh]">
            <h2 class="text-xl font-bold mb-4 flex items-center">
                <i class="fa-solid fa-sliders text-yellow-400 mr-2"></i> Settings
            </h2>
            
            <div class="mb-5">
                <label class="block text-xs uppercase text-gray-400 font-semibold mb-1">Gemini API Key</label>
                <input type="password" id="input-api-key" placeholder="Paste your API Key here" class="w-full bg-gray-900 border border-gray-600 rounded-lg p-3 text-white focus:border-yellow-400 focus:outline-none">
            </div>

            <div class="mb-5">
                <div class="flex justify-between items-center mb-2">
                    <label class="block text-xs uppercase text-gray-400 font-semibold">Explanation Length</label>
                    <span id="lbl-word-count" class="text-xs text-yellow-400 font-bold bg-gray-900 px-2 py-1 rounded">150 words</span>
                </div>
                <input type="range" id="input-word-count" min="60" max="300" step="10" value="150" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
            </div>

            <div class="mb-5">
                <label class="block text-xs uppercase text-gray-400 font-semibold mb-2">Audience</label>
                <div class="flex bg-gray-900 rounded-lg p-1 border border-gray-600">
                    <button class="flex-1 py-2 rounded-md text-sm data-[active=true]:bg-gray-700 data-[active=true]:text-white text-gray-400" id="opt-audience-adult" data-active="true" onclick="setAudience('adult')">Adult</button>
                    <button class="flex-1 py-2 rounded-md text-sm data-[active=true]:bg-indigo-600 data-[active=true]:text-white text-gray-400" id="opt-audience-kid" data-active="false" onclick="setAudience('kid')">Kid</button>
                </div>
            </div>

            <div class="mb-6">
                <label class="block text-xs uppercase text-gray-400 font-semibold mb-2">Language</label>
                <div class="flex bg-gray-900 rounded-lg p-1 border border-gray-600">
                    <button class="flex-1 py-2 rounded-md text-sm data-[active=true]:bg-gray-700 data-[active=true]:text-white text-gray-400" id="opt-lang-en" data-active="true" onclick="setLanguage('en')">English</button>
                    <button class="flex-1 py-2 rounded-md text-sm data-[active=true]:bg-red-600 data-[active=true]:text-white text-gray-400" id="opt-lang-zh" data-active="false" onclick="setLanguage('zh')">中文</button>
                </div>
            </div>

            <button id="btn-save-settings" class="w-full bg-yellow-400 text-black font-bold py-3 rounded-lg">Save & Continue</button>
        </div>
    </div>

    <script>
        const API_KEY = ""; // Execution environment key placeholder
        const TEXT_MODEL = "gemini-2.5-flash-preview-09-2025";
        const TTS_MODEL = "gemini-2.5-flash-preview-tts";

        let state = {
            apiKey: localStorage.getItem('museum_guide_api_key') || '',
            wordCount: parseInt(localStorage.getItem('museum_guide_word_count')) || 150,
            audience: localStorage.getItem('museum_guide_audience') || 'adult',
            language: localStorage.getItem('museum_guide_language') || 'en',
            isProcessing: false
        };

        const els = {
            video: document.getElementById('camera-feed'),
            canvas: document.getElementById('capture-canvas'),
            captureBtn: document.getElementById('btn-capture'),
            settingsBtn: document.getElementById('btn-settings'),
            modal: document.getElementById('settings-modal'),
            apiKeyInput: document.getElementById('input-api-key'),
            wordCountInput: document.getElementById('input-word-count'),
            wordCountLabel: document.getElementById('lbl-word-count'),
            saveSettingsBtn: document.getElementById('btn-save-settings'),
            resultSheet: document.getElementById('result-sheet'),
            explanationText: document.getElementById('explanation-text'),
            loadingState: document.getElementById('loading-state'),
            playBtn: document.getElementById('btn-play'),
            pauseBtn: document.getElementById('btn-pause'),
            closeResultBtn: document.getElementById('btn-close-result'),
            audioPlayer: document.getElementById('ai-audio-player'),
            audAdult: document.getElementById('opt-audience-adult'),
            audKid: document.getElementById('opt-audience-kid'),
            langEn: document.getElementById('opt-lang-en'),
            langZh: document.getElementById('opt-lang-zh'),
        };

        window.onload = () => {
            updateSettingsUI();
            els.wordCountInput.oninput = (e) => els.wordCountLabel.innerText = `${e.target.value} words`;
            if (!state.apiKey) openModal(false); else startCamera();
        };

        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                els.video.srcObject = stream;
            } catch (err) { alert("Camera access denied."); }
        }

        function openModal(allowClose = true) {
            els.modal.classList.remove('hidden');
            setTimeout(() => els.modal.classList.remove('opacity-0'), 10);
            els.apiKeyInput.value = state.apiKey;
            els.wordCountInput.value = state.wordCount;
            els.wordCountLabel.innerText = `${state.wordCount} words`;
        }

        els.saveSettingsBtn.onclick = () => {
            state.apiKey = els.apiKeyInput.value.trim();
            state.wordCount = els.wordCountInput.value;
            localStorage.setItem('museum_guide_api_key', state.apiKey);
            localStorage.setItem('museum_guide_word_count', state.wordCount);
            localStorage.setItem('museum_guide_audience', state.audience);
            localStorage.setItem('museum_guide_language', state.language);
            els.modal.classList.add('opacity-0');
            setTimeout(() => { els.modal.classList.add('hidden'); startCamera(); }, 300);
        };

        window.setAudience = (t) => { state.audience = t; updateSettingsUI(); };
        window.setLanguage = (l) => { state.language = l; updateSettingsUI(); };
        function updateSettingsUI() {
            els.audAdult.dataset.active = state.audience === 'adult';
            els.audKid.dataset.active = state.audience === 'kid';
            els.langEn.dataset.active = state.language === 'en';
            els.langZh.dataset.active = state.language === 'zh';
        }

        els.captureBtn.onclick = async () => {
            if (state.isProcessing) return;

            // iOS FIX: Initialize audio engine on user gesture
            els.audioPlayer.play().catch(() => {}); 
            els.audioPlayer.pause();

            state.isProcessing = true;
            els.captureBtn.classList.add('animate-pulse-ring');
            
            const context = els.canvas.getContext('2d');
            els.canvas.width = els.video.videoWidth;
            els.canvas.height = els.video.videoHeight;
            context.drawImage(els.video, 0, 0, els.canvas.width, els.canvas.height);
            const base64Image = els.canvas.toDataURL('image/jpeg', 0.8).split(',')[1];

            showResultSheet(true);

            try {
                const text = await getAIExplanation(base64Image);
                els.explanationText.innerText = text;
                await playAIVoice(text);
            } catch (err) {
                els.explanationText.innerText = "Error: " + err.message;
            } finally {
                state.isProcessing = false;
                els.captureBtn.classList.remove('animate-pulse-ring');
                showResultSheet(false);
            }
        };

        async function getAIExplanation(imageData) {
            let prompt = state.language === 'en' 
                ? `Museum guide for ${state.audience}. Identify this. Explain simply in ${state.wordCount} words.`
                : `博物館導覽(${state.audience})。請辨識並以繁體中文解釋，約${state.wordCount}字。`;

            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${TEXT_MODEL}:generateContent?key=${state.apiKey}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/jpeg", data: imageData } }] }]
                })
            });
            const data = await res.json();
            if (data.error) throw new Error(data.error.message);
            return data.candidates[0].content.parts[0].text;
        }

        async function playAIVoice(text) {
            const voice = state.audience === 'kid' ? "Puck" : "Kore";
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${TTS_MODEL}:generateContent?key=${state.apiKey}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: `Say clearly: ${text}` }] }],
                    generationConfig: { 
                        responseModalities: ["AUDIO"], 
                        speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: voice } } } 
                    }
                })
            });
            const data = await res.json();
            const pcmBase64 = data.candidates[0].content.parts[0].inlineData.data;
            
            // Convert PCM to WAV for Browser Playback
            const wavBlob = pcmToWav(pcmBase64, 24000); 
            const url = URL.createObjectURL(wavBlob);
            els.audioPlayer.src = url;
            els.audioPlayer.play();
        }

        function pcmToWav(base64, sampleRate) {
            const buffer = Uint8Array.from(atob(base64), c => c.charCodeAt(0)).buffer;
            const view = new DataView(new ArrayBuffer(44 + buffer.byteLength));
            const writeString = (offset, string) => { for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i)); };
            writeString(0, 'RIFF');
            view.setUint32(4, 32 + buffer.byteLength, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, 1, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(36, 'data');
            view.setUint32(40, buffer.byteLength, true);
            const pcm = new Uint8Array(buffer);
            for (let i = 0; i < pcm.length; i++) view.setUint8(44 + i, pcm[i]);
            return new Blob([view], { type: 'audio/wav' });
        }

        function showResultSheet(loading) {
            els.resultSheet.style.transform = "translateY(10%)";
            els.loadingState.classList.toggle('hidden', !loading);
            els.explanationText.classList.toggle('hidden', loading);
        }

        els.playBtn.onclick = () => els.audioPlayer.play();
        els.pauseBtn.onclick = () => els.audioPlayer.pause();
        els.closeResultBtn.onclick = () => {
            els.resultSheet.style.transform = "translateY(110%)";
            els.audioPlayer.pause();
        };
        els.settingsBtn.onclick = () => openModal(true);
    </script>
</body>
</html>
